{% extends "base/base.html" %}
{% load static %}
{% load i18n %} 


<!--begin::Toolbar-->
{% block toolbar %}
<div id="kt_app_toolbar" class="app-toolbar pt-4 pt-lg-7 mb-n1 mb-lg-n3">
	<!--begin::Toolbar container-->
	<div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack flex-row-fluid">
		<!--begin::Toolbar container-->
		<div class="d-flex flex-stack flex-row-fluid">
			
			<!--begin::Toolbar container-->
			<div class="d-flex flex-column flex-row-fluid">
				<!--begin::Toolbar wrapper-->
				<!--begin::Breadcrumb-->
				<ul class="breadcrumb breadcrumb-separatorless fw-semibold mb-1 mb-lg-3 me-2 fs-7">
					<!--begin::Item-->
					<li class="breadcrumb-item text-gray-700 fw-bold lh-1">
						<a href="{% url 'accueil' %}" class="text-white text-hover-primary">
							<i class="ki-outline ki-home text-gray-700 fs-6"></i>
						</a>
					</li>
					<!--end::Item-->
					<!--begin::Item-->
					<li class="breadcrumb-item">
						<i class="ki-outline ki-right fs-7 text-gray-700 mx-n1"></i>
					</li>
					<!--end::Item-->
					<!--begin::Item-->
					<li class="breadcrumb-item text-gray-700 fw-bold lh-1"> {% block toolbar_menu %} Incidents {% endblock %} </li>
					<!--end::Item-->
                    <!--begin::Item-->
					<li class="breadcrumb-item">
						<i class="ki-outline ki-right fs-7 text-gray-700 mx-n1"></i>
					</li>
					<!--end::Item-->
					<!--begin::Item-->
					<li class="breadcrumb-item text-gray-700 fw-bold lh-1">Création</li>
					<!--end::Item-->
				</ul>
				<!--end::Breadcrumb-->
			</div>
			<!--end::Toolbar container-->
             <!--begin::Actions-->
			<div class="d-flex align-items-center gap-3">
				<!--begin::Secondary button-->
				<div class="m-0">
					<!--begin::Menu-->
					<a href="{% url 'incident_list' %}" class="btn btn-sm fw-bold btn-secondary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">Historique des incidents</a>
					<!--end::Menu-->
				</div>
				<!--end::Secondary button-->
				{% if dashboard_type == 'superuser' %}
				<button id="toggleLeaderboardBtn" class="btn btn-sm btn-primary">
					<i class="fas fa-trophy me-1"></i>
					<span class="toggle-text">Afficher Classement</span>
				</button>
			{% endif %}
			</div>
			<!--end::Actions-->
		</div>
		<!--end::Toolbar container-->
	</div>
	<!--end::Toolbar container-->
</div>
{% endblock toolbar %}
<!--end::Toolbar-->

{% block content %}

<!-- Dans le bloc content, avant le formulaire -->
<style>
    /* Ajoutez ces styles pour améliorer l'expérience utilisateur */
    .form-control-solid {
        transition: all 0.3s ease;
        border: 1px solid #e4e6ef;
    }
    
    .form-control-solid:focus {
        border-color: #3699ff;
        box-shadow: 0 0 0 3px rgba(54, 153, 255, 0.1);
    }
    
    .required-field::after {
        content: " *";
        color: #f64e60;
    }
    
    .form-section {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-hint {
        font-size: 0.85rem;
        color: #7e8299;
        margin-top: 0.25rem;
    }
    
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }
    
    .file-upload-container {
        border: 2px dashed #e4e6ef;
        padding: 20px;
        text-align: center;
        border-radius: 6px;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .file-upload-container:hover {
        border-color: #3699ff;
        background-color: #f1faff;
    }

    .bg-custom-primary {
    background-color: #132048 !important;
}

.checklist-section {
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.checklist-section.completed {
    background-color: #f8fff8;
    border-left: 3px solid #50cd89;
}

.checklist-section.incomplete {
    background-color: #fff8f8;
    border-left: 3px solid #f64e60;
}

.sticky-top {
    position: -webkit-sticky;
    position: sticky;
    z-index: 10;
}

.form-check-input:checked {
    background-color: #50cd89;
    border-color: #50cd89;
}
</style>

<div class="content flex-row-fluid" id="kt_content">
    <div class="row">
        <!-- Colonne principale  -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header text-dark text-center">
                    <h3 class="card-title fw-bold mb-0">{% trans "Déclaration d'incident" %}</h3>
                </div>
        
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" class="form mb-0" id="kt_contact_form">
                        {% csrf_token %}
                        
                        <!-- Section 1: Informations de base -->
                        <div class="form-section mb-8">
                            <div class="d-flex align-items-center mb-4">
                                <span class="bullet bullet-vertical h-40px bg-custom-primary"></span>
                                <h4 class="text-gray-800 fs-4 fw-bold ms-4"> {% trans "1. Informations de base" %}</h4>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex flex-column mb-4 fv-row">
                                        <label class="fs-5 fw-semibold mb-2 required-field" >{{ form.name.label }}</label>
                                        {{ form.name }}
                                    </div>
                                    <div class="form-hint"> {% trans "Donnez un titre clair et descriptif à votre incident" %} </div>
        
                                    <!-- Type (PA/OSE) -->
                                    <div class="d-flex flex-column mb-4 fv-row">
                                        <label class="fs-5 fw-semibold mb-2 required-field">{{ form.type_incident.label }}</label>
                                        {{ form.type_incident }}
                                        <div class="form-hint"> {% trans "Sélectionnez le type d'incident (Presque-Accident ou Observation Sécurité/Environnement)" %}</div>
                                        {% if form.type_incident.errors %}
                                            <div class="text-danger mt-2">{{ form.type_incident.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex flex-column mb-4 fv-row" >
                                <label class="fs-5 fw-semibold mb-2 required-field">{{ form.description.label }}</label>
                                {{ form.description }}
                                <div class="form-hint">{% trans "Décrivez l'incident de manière détaillée (quoi, comment...)" %}</div>
                            </div>
                        </div>
                        
                        <div class="separator separator-dashed my-6"></div>
                        
                        
                        <!-- Section 2: Questions spécifiques (affichage conditionnel) -->
                        <div class="form-section" id="pa_section" style="display:none;">
                            <div class="d-flex align-items-center mb-4">
                                <span class="bullet bullet-vertical h-40px bg-custom-primary"></span>
                                <h4 class="text-gray-800 fs-4 fw-bold ms-4"> {% trans "2. Questions spécifiques Presque-Accident" %} </h4>
                            </div>
                            
                            <div class="d-flex flex-column mb-4 fv-row">
                                <label class="fs-5 fw-semibold mb-2 required-field">{{ form.blessure_potentielle.label }}</label>
                                {{ form.blessure_potentielle }}
                                {% if form.blessure_potentielle.errors %}
                                    <div class="text-danger mt-2">{{ form.blessure_potentielle.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex flex-column mb-4 fv-row">
                                <label class="fs-5 fw-semibold mb-2 required-field">{{ form.cause_principale.label }}</label>
                                {{ form.cause_principale }}
                                {% if form.cause_principale.errors %}
                                    <div class="text-danger mt-2">{{ form.cause_principale.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex flex-column mb-4 fv-row">
                                <label class="fs-5 fw-semibold mb-2 required-field">{{ form.consequence_pa.label }}</label>
                                {{ form.consequence_pa }}
                                {% if form.consequence_pa.errors %}
                                    <div class="text-danger mt-2">{{ form.consequence_pa.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex flex-column mb-4 fv-row">
                                <label class="fs-5 fw-semibold mb-2">{{ form.solution_pa.label }}</label>
                                {{ form.solution_pa }}
                                {% if form.solution_pa.errors %}
                                    <div class="text-danger mt-2">{{ form.solution_pa.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="separator separator-dashed my-6"></div>
                        </div>
                        
                        <div class="form-section" id="ose_section" style="display:none;">
                            <div class="d-flex align-items-center mb-4">
                                <span class="bullet bullet-vertical h-40px bg-primary"></span>
                                <h4 class="text-gray-800 fs-4 fw-bold ms-4"> {% trans "2. Questions spécifiques Observation Sécurité/Environnement" %} </h4>
                            </div>
                            
                            <div class="d-flex flex-column mb-4 fv-row">
                                <label class="fs-5 fw-semibold mb-2 required-field">{{ form.consequence_ose.label }}</label>
                                {{ form.consequence_ose }}
                                {% if form.consequence_ose.errors %}
                                    <div class="text-danger mt-2">{{ form.consequence_ose.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex flex-column mb-4 fv-row">
                                <label class="fs-5 fw-semibold mb-2">{{ form.solution_ose.label }}</label>
                                {{ form.solution_ose }}
                                {% if form.solution_ose.errors %}
                                    <div class="text-danger mt-2">{{ form.solution_ose.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex flex-column mb-4 fv-row">
                                <label class="fs-5 fw-semibold mb-2 required-field">{% trans "Action de correction immédiate ?" %}</label>
                                <select class="form-select form-control form-control-solid" name="action_correction" id="id_action_correction">
                                    <option value="">---------</option>
                                    <option value="true">{% trans "Oui" %}</option>
                                    <option value="false">{% trans "Non" %}</option>
                                </select>
                            </div>
                            
                            <div id="correction_section" style="display:none;">
                                <div class="d-flex flex-column mb-4 fv-row">
                                    <label class="fs-5 fw-semibold mb-2">{{ form.photo_correction.label }}</label>
                                    {{ form.photo_correction }}
                                    {% if form.photo_correction.errors %}
                                        <div class="text-danger mt-2">{{ form.photo_correction.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="d-flex flex-column mb-4 fv-row">
                                    <label class="fs-5 fw-semibold mb-2">{{ form.commentaire_correction.label }}</label>
                                    {{ form.commentaire_correction }}
                                    {% if form.commentaire_correction.errors %}
                                        <div class="text-danger mt-2">{{ form.commentaire_correction.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="separator separator-dashed my-6"></div>
                        </div>
        
                        <!-- Section 3: Localisation -->
                        <div class="form-section mb-8">
                            <div class="d-flex align-items-center mb-4">
                                <span class="bullet bullet-vertical h-40px bg-custom-primary"></span>
                                <h4 class="text-gray-800 fs-4 fw-bold ms-4">{% trans "3. Localisation" %} </h4>
                            </div>
                            
                            <!-- Site et Emplacement côte à côte -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex flex-column mb-4 fv-row">
                                        <label class="fs-5 fw-semibold mb-2 required-field">{{ form.site.label }}</label>
                                        {{ form.site }}
                                    </div>
                                </div>
        
                                <div class="col-md-6">
                                    <div class="d-flex flex-column mb-4 fv-row">
                                        <label class="fs-5 fw-semibold mb-2">{{ form.emplacement.label }}</label>
                                        {{ form.emplacement }}
                                        <div class="form-hint">{% trans "Sélectionnez d'abord un site pour voir les emplacements disponibles" %} </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Lieu (saisie manuelle) - Pleine largeur -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex flex-column mb-4 fv-row">
                                        <label class="fs-5 fw-semibold mb-2">{{ form.location.label }}</label>
                                        {{ form.location }}
                                        <div class="form-hint"> {% trans "Précisez le lieu exact si nécessaire (bâtiment, étage, zone...)" %} </div>
                                        {% if form.location.errors %}
                                            <div class="text-danger mt-2">{{ form.location.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="separator separator-dashed my-6"></div>
                        
                        <!-- Section 4: Documentation -->
                        <div class="form-section mb-8">
                            <div class="d-flex align-items-center mb-4">
                                <span class="bullet bullet-vertical h-40px bg-custom-primary"></span>
                                <h4 class="text-gray-800 fs-4 fw-bold ms-4">{% trans "4. Documentation" %} </h4>
                            </div>
                            
                                <!-- <div class="col-md-6">
                                    <div class="d-flex flex-column mb-4 fv-row">
                                        <label class="fs-5 fw-semibold mb-2">{{ form.criticity.label }}</label>
                                        {{ form.criticity }}
                                    </div>
                                </div>
                                -->
                        
                            <div class="d-flex flex-column mb-4 fv-row">
                                <label class="fs-5 fw-semibold mb-2">{{ form.photo.label }}</label>
                                <div class="file-upload-container">
                                    {{ form.photo }}
                                </div>
                                <div class="form-hint">{% trans "Glissez-déposez une photo ou cliquez pour sélectionner" %}</div>
                            </div>
                    
                            
                            
                            <div class="d-flex flex-column mb-4 fv-row">
                                <label class="fs-5 fw-semibold mb-2">{{ form.comment.label }}</label>
                                {{ form.comment }}
                                <div class="form-hint"> {% trans "Ajoutez tout commentaire supplémentaire utile" %} </div>
                            </div>
                        </div>
        
                        <div class="separator my-4"></div>
        
                        <div class="d-flex justify-content-end">
                            <a class="btn btn-light me-3" href="{% url 'incident_list' %}">
                                <i class="fas fa-undo me-2"></i> {% trans "Annuler" %}
                            </a>
                            <button type="submit" class="btn" style="background-color: #ffcf01; color: #000;">
                                <i class="fas fa-check-circle me-2 text-dark"></i> {% trans "Soumettre la déclaration" %}
                            </button>
                        </div>
                    </form>
                </div>
                
            </div>
        </div>

        <!-- Sidebar de résumé (4 colonnes) -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h3 class="card-title fw-bold">{% trans "Résumé & Checklist" %}</h3>
                    <div class="card-toolbar">
                        <span class="badge badge-light-primary">{% trans "Progression" %}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column mb-8">
                        <!-- Indicateur de progression -->
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-grow-1">
                                <div class="progress h-8px">
                                    <div class="progress-bar bg-primary" id="form-progress" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <span class="text-muted ms-2" id="progress-percentage">0%</span>
                        </div>
                        
                        <!-- Checklist des sections -->
                        <div class="mb-6">
                            <h4 class="fw-bold mb-3"> {% trans "Sections à compléter" %} </h4>
                            <div class="checklist-section" data-section="informations">
                                <div class="form-check form-check-custom form-check-solid mb-2">
                                    <input class="form-check-input" type="checkbox" disabled id="check-info">
                                    <label class="form-check-label" for="check-info">
                                        <span class="fw-semibold"> {% trans "1. Informations de base" %}</span>
                                    </label>
                                </div>
                                <div class="ms-6 mb-3 text-muted">
                                    <small class="d-block"><span id="info-status">0/3</span>{% trans "champs requis" %}</small>
                                </div>
                            </div>
                            
                            <div class="checklist-section" data-section="localisation">
                                <div class="form-check form-check-custom form-check-solid mb-2">
                                    <input class="form-check-input" type="checkbox" disabled id="check-localisation">
                                    <label class="form-check-label" for="check-localisation">
                                        <span class="fw-semibold">{% trans "2. Localisation" %}</span>
                                    </label>
                                </div>
                                <div class="ms-6 mb-3 text-muted">
                                    <small class="d-block"><span id="localisation-status">0/1</span> {% trans "champs requis" %} </small>
                                </div>
                            </div>
                            
                            <div class="checklist-section" data-section="questions">
                                <div class="form-check form-check-custom form-check-solid mb-2">
                                    <input class="form-check-input" type="checkbox" disabled id="check-questions">
                                    <label class="form-check-label" for="check-questions">
                                        <span class="fw-semibold">{% trans "3. Questions spécifiques" %}</span>
                                    </label>
                                </div>
                                <div class="ms-6 mb-3 text-muted">
                                    <small class="d-block"><span id="questions-status">0/4</span> {% trans "champs requis" %} </small>
                                </div>
                            </div>
                            
                            <div class="checklist-section" data-section="documentation">
                                <div class="form-check form-check-custom form-check-solid">
                                    <input class="form-check-input" type="checkbox" disabled id="check-doc">
                                    <label class="form-check-label" for="check-doc">
                                        <span class="fw-semibold">{% trans "4. Documentation" %}</span>
                                    </label>
                                </div>
                                <div class="ms-6 mb-3 text-muted">
                                    <small class="d-block"><span id="doc-status">0/1</span> {% trans "champs requis" %} </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Résumé avant soumission -->
                        <div class="border-top pt-6">
                            <h4 class="fw-bold mb-3">{% trans "Vérification finale" %}</h4>
                            <ul class="list-unstyled">
                                <li class="d-flex align-items-center mb-3">
                                    <span class="bullet bullet-dot bg-success me-3"></span>
                                    <span> {% trans "Tous les champs requis sont remplis" %} </span>
                                </li>
                                <li class="d-flex align-items-center mb-3">
                                    <span class="bullet bullet-dot bg-success me-3"></span>
                                    <span> {% trans "Les photos sont claires et lisibles" %} </span>
                                </li>
                                <li class="d-flex align-items-center">
                                    <span class="bullet bullet-dot bg-success me-3"></span>
                                    <span> {% trans "La description est complète et précise" %}</span>
                                </li>
                            </ul>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Gestion du chargement dynamique des emplacements
    $("#id_site").change(function() {
        var siteId = $(this).val();
        if (siteId) {
            $.ajax({
                url: "{% url 'get_emplacements' %}",  
                data: { 'site_id': siteId },
                dataType: 'json',
                success: function(data) {
                    var $emplacement = $("#id_emplacement");
                    $emplacement.empty();
                    $emplacement.append(new Option("---------", ""));
                    $.each(data, function(index, item) {
                        $emplacement.append(new Option(item.name, item.id));
                    });
                }
            });
        }
    }).trigger('change');
    
    // Gestion de l'affichage conditionnel des sections PA/OSE
    $("#id_type_incident").change(function() {
        var type = $(this).val();
        
        // Masquer toutes les sections spécifiques
        $("#pa_section, #ose_section").hide();
        
        // Afficher la section correspondante
        if (type === "PA") {
            $("#pa_section").show();
        } else if (type === "OSE") {
            $("#ose_section").show();
        }
    });
    
    // Gestion de l'affichage conditionnel de la section correction OSE
    $("#id_action_correction").change(function() {
        if ($(this).val() === "true") {
            $("#correction_section").show();
        } else {
            $("#correction_section").hide();
        }
    });
});
</script>

<script>
    $(document).ready(function() {
        // Ajoute la classe 'is-filled' aux champs non vides
        $('input, textarea, select').each(function() {
            if ($(this).val()) {
                $(this).addClass('is-filled');
            }
        });
        
        // Gestion du style des champs lorsqu'ils sont remplis
        $('input, textarea, select').on('change input', function() {
            if ($(this).val()) {
                $(this).addClass('is-filled');
            } else {
                $(this).removeClass('is-filled');
            }
        });
        
        // Animation pour les champs requis non remplis
        $('form').on('submit', function(e) {
            $('.required-field').each(function() {
                const fieldName = $(this).text().replace(' *', '').trim();
                const field = $('[name="' + fieldName.toLowerCase().replace(/ /g, '_') + '"]');
                
                if (!field.val()) {
                    field.addClass('is-invalid');
                    setTimeout(() => {
                        field.removeClass('is-invalid');
                    }, 3000);
                }
            });
        });
        
        // Amélioration de l'upload de fichier
        $('.file-upload-container').on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });
        
        $('.file-upload-container').on('dragleave drop', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });
        
    });
</script>

<script>
    $(document).ready(function() {
        // Configuration des champs requis par section
        const requiredFields = {
            'informations': ['id_name', 'id_type_incident', 'id_description'],
            'localisation': ['id_site'],
            'questions': [], // Seront remplis dynamiquement selon PA/OSE
            'documentation': ['id_photo']
        };
        
        // Mise à jour initiale
        updateChecklist();
        
        // Écouteurs d'événements pour la mise à jour
        $('input, textarea, select').on('change input', function() {
            updateChecklist();
        });
        
        // Gestion dynamique des champs PA/OSE
        $('#id_type_incident').change(function() {
            const type = $(this).val();
            if (type === 'PA') {
                requiredFields.questions = [
                    'id_blessure_potentielle', 
                    'id_cause_principale', 
                    'id_consequence_pa', 
                    'id_solution_pa'
                ];
            } else if (type === 'OSE') {
                requiredFields.questions = [
                    'id_consequence_ose', 
                    'id_solution_ose'
                ];
            } else {
                requiredFields.questions = [];
            }
            updateChecklist();
        });
        
        function updateChecklist() {
            let totalFields = 0;
            let completedFields = 0;
            
            // Parcourir chaque section
            for (const section in requiredFields) {
                const fields = requiredFields[section];
                let sectionCompleted = 0;
                
                fields.forEach(fieldId => {
                    totalFields++;
                    const field = $('#' + fieldId);
                    if (field.val() && field.val().toString().trim() !== '') {
                        completedFields++;
                        sectionCompleted++;
                    }
                });
                
                // Mettre à jour l'UI de la section
                const sectionElement = $(`.checklist-section[data-section="${section}"]`);
                const statusElement = $(`#${section}-status`);
                
                if (fields.length > 0) {
                    statusElement.text(`${sectionCompleted}/${fields.length}`);
                    
                    if (sectionCompleted === fields.length) {
                        sectionElement.addClass('completed').removeClass('incomplete');
                        sectionElement.find('.form-check-input').prop('checked', true);
                    } else {
                        sectionElement.addClass('incomplete').removeClass('completed');
                        sectionElement.find('.form-check-input').prop('checked', false);
                    }
                }
            }
            
            // Mettre à jour la progression globale
            const progressPercentage = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;
            $('#form-progress').css('width', progressPercentage + '%');
            $('#progress-percentage').text(progressPercentage + '%');
            
            // Activer/désactiver le bouton de soumission si tout est complet
            if (completedFields === totalFields && totalFields > 0) {
                $('button[type="submit"]').prop('disabled', false);
            } else {
                $('button[type="submit"]').prop('disabled', true);
            }
        }
        
    });
</script>
{% endblock %}