{% extends "base/base.html" %}

{% load static %}

{% load param_replace %} 

{% block toolbar %}
<!--begin::Toolbar-->
<div id="kt_app_toolbar" class="app-toolbar pt-4 pt-lg-7 mb-n1 mb-lg-n3">
	<!--begin::Toolbar container-->
	<div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack flex-row-fluid">
		<!--begin::Toolbar container-->
		<div class="d-flex flex-stack flex-row-fluid">
			
			<!--begin::Toolbar container-->
			<div class="d-flex flex-column flex-row-fluid">
				<!--begin::Toolbar wrapper-->
				<!--begin::Breadcrumb-->
				<ul class="breadcrumb breadcrumb-separatorless fw-semibold mb-1 mb-lg-3 me-2 fs-7">
					<!--begin::Item-->
					<li class="breadcrumb-item text-gray-700 fw-bold lh-1">
						<a href="{% url 'accueil' %}" class="text-white text-hover-primary">
							<i class="ki-outline ki-home text-gray-700 fs-6"></i>
						</a>
					</li>
					<!--end::Item-->
					<!--begin::Item-->
					<li class="breadcrumb-item">
						<i class="ki-outline ki-right fs-7 text-gray-700 mx-n1"></i>
					</li>
					<!--end::Item-->
					<!--begin::Item-->
					<li class="breadcrumb-item text-gray-700 fw-bold lh-1"> {% block toolbar_menu %} Incident {% endblock %} </li>
					<!--end::Item-->

                    <!--begin::Item-->
					<li class="breadcrumb-item">
						<i class="ki-outline ki-right fs-7 text-gray-700 mx-n1"></i>
					</li>
					<!--end::Item-->
					<!--begin::Item-->
					<li class="breadcrumb-item text-gray-700 fw-bold lh-1">Liste</li>
					<!--end::Item-->

				</ul>
				<!--end::Breadcrumb-->
				<!--begin::Page title-->
				<div class="page-title d-flex align-items-center me-3">
					<!--begin::Title-->
					<h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">{% block toolbar_title %} Liste des incidents {% endblock %}</h1>
					<!--end::Title-->
				</div>
				<!--end::Page title-->
			</div>
			<!--end::Toolbar container-->
			
			<!--begin::Actions-->
			<div class="d-flex align-items-center gap-3">
				<!--begin::Secondary button-->
				<div class="m-0">
					<!--begin::Menu-->
					<a href="{% url 'incident_list' %}" class="btn btn-sm fw-bold btn-secondary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">Historique des incidents</a>
					<!--end::Menu-->
				</div>
			</div>
			<!--end::Actions-->
		</div>
		<!--end::Toolbar container-->
	</div>
	<!--end::Toolbar container-->
</div>
<!--end::Toolbar-->
{% endblock %}

{% block content %}

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<div class="content flex-row-fluid" id="kt_content">
    
    <!--begin::Card-->
    <div class="card">

        <!--begin::Card header-->
        <div class="card-header border-0 pt-6">
            <!--begin::Card title-->
            <div class="card-title">
                <form method="get" class="d-flex align-items-center gap-4 flex-wrap">
                    <!-- Sélecteur de champ (largeur fixe) -->
                    <div style="width: 180px;">
                        <select id="searchFieldSelector" class="form-select form-select-solid">
                            <option value="">Choisir un champ...</option>
                            <option value="#referenceField">Référence</option>
                            <option value="#nameField">Nom</option>
                            <option value="#statusField">Statut</option>
                            <option value="#type_incidentField">Type d'incident</option>
                            <option value="#dateField">Date</option>
                        </select>
                    </div>

                    <!-- Conteneur des champs (s'adapte dynamiquement) -->
                    <div class="flex-grow-1" style="min-width: 250px; max-width: 400px;">
                        <!-- Référence -->
                        <div id="referenceField" class="search-field" style="display:block;">
                            {{ filter.form.reference }}
                        </div>
                        
                        <!-- Nom -->
                        <div id="nameField" class="search-field" style="display:none;">
                            {{ filter.form.name }}
                        </div>
                        
                        <!-- Statut -->
                        <div id="statusField" class="search-field" style="display:none;">
                            {{ filter.form.status }}
                        </div>
                        
                        <!-- Catégorie -->
                        <div id="type_incidentField" class="search-field" style="display:none;">
                            {{ filter.form.type_incident }}
                        </div>
                        
                        <!-- Date -->
                        <div id="dateField" class="search-field" style="display:none;">
                            {{ filter.form.report_date }}
                        </div>
                    </div>

                    <!-- Boutons (alignement fixe) -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn" style="background-color: #ffcf01; color: #000;" id="searchButton">
                            <i class="ki-duotone ki-filter text-dark">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i> Filtrer
                        </button>
                        <a href="?" class="btn btn-light" id="resetButton">
                            <i class="fas fa-undo me-2"></i>Réinitialiser</a>
                    </div>
                </form>
            </div>
            <!--end::Card title-->
            
            <!--begin::Card toolbar-->
            {% if perms.incident.add_incident %}
            <div class="card-toolbar">   
                <!--begin::Toolbar-->
                <div class="d-flex justify-content-end" data-kt-incident-table-toolbar="base">
                    <!-- Select nombre de lignes -->
                    <select class="form-select form-select-solid w-100px me-3 pe-2" onchange="window.location.href=updateQueryStringParameter(window.location.href, 'per_page', this.value)">
                        <option value="10" {% if per_page == '10' %}selected{% endif %}>10 lignes</option>
                        <option value="25" {% if per_page == '25' %}selected{% endif %}>25 lignes</option>
                        <option value="50" {% if per_page == '50' %}selected{% endif %}>50 lignes</option>
                    </select>

                    <!--begin::Export-->
                    <a href="?{% param_replace export='excel' %}" class="btn me-3" style="background-color: #ffcf01; color: #000;">
                        <i class="ki-duotone ki-exit-up fs-2 text-dark">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i> Exporter
                    </a>
                    <!--end::Export-->

                    <!--begin::Add incident-->
                    <a href="{% url 'incident_create' %}" class="btn" style="background-color: #ffcf01; color: #000;">
                        <i class="ki-duotone ki-plus fs-2 text-dark"></i>Nouvel incident
                    </a>
                    <!--end::Add incident-->
                </div>
                <!--end::Toolbar-->
            </div>
            <!--end::Card toolbar-->
            {% endif %}
        </div>
        <!--end::Card header-->
        
        <!--begin::Card body-->
        <div class="card-body pt-0">
            <!--begin::Table-->
            <div style="overflow-x: auto;">
                <table class="table align-middle table-row-dashed fs-6 gy-5" id="kt_incidents_table">
                    <thead>
                        <tr class="text-start text-muted fw-bold fs-7 text-uppercase gs-0">
                            <th class="w-10px pe-2">
                                <div class="form-check form-check-sm form-check-custom form-check-solid me-3">
                                    <input class="form-check-input" type="checkbox" data-kt-check="true" data-kt-check-target="#kt_incidents_table .form-check-input" value="1" />
                                </div>
                            </th>
                            <th class="min-w-125px">
                                <a href="?{% param_replace sort='reference' %}" class="text-muted">
                                    Référence
                                    {% if sort_field == 'reference' %}
                                        <i class="ki-duotone ki-arrow-down fs-2 ms-2"></i>
                                    {% elif sort_field == '-reference' %}
                                        <i class="ki-duotone ki-arrow-up fs-2 ms-2"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="min-w-125px">
                                <a href="?{% param_replace sort='name' %}" class="text-muted">
                                    Nom
                                    {% if sort_field == 'name' %}
                                        <i class="ki-duotone ki-arrow-down fs-2 ms-2"></i>
                                    {% elif sort_field == '-name' %}
                                        <i class="ki-duotone ki-arrow-up fs-2 ms-2"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="min-w-125px">
                                <a href="?{% param_replace sort='report_date' %}" class="text-muted">
                                    Date
                                    {% if sort_field == 'report_date' %}
                                        <i class="ki-duotone ki-arrow-down fs-2 ms-2"></i>
                                    {% elif sort_field == '-report_date' %}
                                        <i class="ki-duotone ki-arrow-up fs-2 ms-2"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="min-w-125px">
                                <a href="?{% param_replace sort='description' %}" class="text-muted">
                                    Description
                                    {% if sort_field == 'description' %}
                                        <i class="ki-duotone ki-arrow-down fs-2 ms-2"></i>
                                    {% elif sort_field == '-description' %}
                                        <i class="ki-duotone ki-arrow-up fs-2 ms-2"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="min-w-125px">
                                <a href="?{% param_replace sort='type_incident' %}" class="text-muted">
                                    Type d'incident
                                    {% if sort_field == 'type_incident' %}
                                        <i class="ki-duotone ki-arrow-down fs-2 ms-2"></i>
                                    {% elif sort_field == '-type_incident' %}
                                        <i class="ki-duotone ki-arrow-up fs-2 ms-2"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="min-w-100px">
                                <a href="?{% param_replace sort='criticity' %}" class="text-muted">
                                    Statut
                                    {% if sort_field == 'status' %}
                                        <i class="ki-duotone ki-arrow-down fs-2 ms-2"></i>
                                    {% elif sort_field == '-status' %}
                                        <i class="ki-duotone ki-arrow-up fs-2 ms-2"></i>
                                    {% endif %}
                                </a>
                            </th>  
                            <th class="min-w-125px">
                                <a href="?{% param_replace sort='site' %}" class="text-muted">
                                    Site
                                    {% if sort_field == 'site' %}
                                        <i class="ki-duotone ki-arrow-down fs-2 ms-2"></i>
                                    {% elif sort_field == '-site' %}
                                        <i class="ki-duotone ki-arrow-up fs-2 ms-2"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="min-w-125px">
                                <a href="?{% param_replace sort='emplacement' %}" class="text-muted">
                                    Emplacement
                                    {% if sort_field == 'emplacement' %}
                                        <i class="ki-duotone ki-arrow-down fs-2 ms-2"></i>
                                    {% elif sort_field == '-emplacement' %}
                                        <i class="ki-duotone ki-arrow-up fs-2 ms-2"></i>
                                    {% endif %}
                                </a>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 fw-semibold">
                        {% for incident in incidents %}
                        <tr>
                            <td>
                                <div class="form-check form-check-sm form-check-custom form-check-solid">
                                    <input class="form-check-input" type="checkbox" value="1" />
                                </div>
                            </td>
                            <td><a href="{% url 'incident_detail' incident.pk %}">{{ incident.reference }} </a></td> 
                            <td> {{ incident.name }}</td>
                            <td>{{ incident.report_date }}</td>
                            <td>{{ incident.description }}</td>
                            <td>{{ incident.type_incident }}</td>
                            <td>
                                <span style="
                                    padding: 5px 10px;
                                    border-radius: 5px;
                                    background-color: 
                                        {% if incident.status == 'pending' %} #ffcccb
                                        {% elif incident.status == 'ongoing' %} #add8e6
                                        {% elif incident.status == 'resolved' %} #90ee90
                                        {% elif incident.status == 'done' %} #d3d3d3
                                        {% else %} #f0f0f0 {% endif %};
                                ">
                                    {{ incident.get_status_display }}
                                </span>
                            </td>
                            <td>{{ incident.site }}</td>
                            <td>{{ incident.emplacement.name}}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="12">Aucun incident signalé.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
            </div>
            <!--end::Table-->

            <!--begin::Pagination-->
            {% if incidents.has_other_pages %}
            <div class="row mt-4">
                <div class="col-sm-12 col-md-5 d-flex align-items-center justify-content-center justify-content-md-start">
                    <div class="dataTables_info">
                        Affichage de {{ incidents.start_index }} à {{ incidents.end_index }} sur {{ incidents.paginator.count }} incidents
                    </div>
                </div>
                <div class="col-sm-12 col-md-7 d-flex align-items-center justify-content-center justify-content-md-end">
                    <div class="dataTables_paginate paging_simple_numbers">
                        <ul class="pagination">
                            {% if incidents.has_previous %}
                                <li class="paginate_button page-item previous">
                                    <a href="?{% param_replace page=1 %}" class="page-link">&laquo; Première</a>
                                </li>
                                <li class="paginate_button page-item">
                                    <a href="?{% param_replace page=incidents.previous_page_number %}" class="page-link">Précédent</a>
                                </li>
                            {% endif %}

                            {% for num in incidents.paginator.page_range %}
                                {% if incidents.number == num %}
                                    <li class="paginate_button page-item active">
                                        <a href="?{% param_replace page=num %}" class="page-link">{{ num }}</a>
                                    </li>
                                {% elif num > incidents.number|add:'-3' and num < incidents.number|add:'3' %}
                                    <li class="paginate_button page-item">
                                        <a href="?{% param_replace page=num %}" class="page-link">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if incidents.has_next %}
                                <li class="paginate_button page-item">
                                    <a href="?{% param_replace page=incidents.next_page_number %}" class="page-link">Suivant</a>
                                </li>
                                <li class="paginate_button page-item next">
                                    <a href="?{% param_replace page=incidents.paginator.num_pages %}" class="page-link">Dernière &raquo;</a>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}
            <!--end::Pagination-->

        </div>
        <!--end::Card body-->
    </div>

  

    <!--end::Card-->
</div>

<script>
    $(document).ready(function() {
        // Gérer la soumission du formulaire
        $('#kt_contact_form').on('submit', function(e) {
            e.preventDefault(); 

            $.ajax({
                url: "{% url 'incident_list' %}",
                method: "POST",
                data: new FormData(this),
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        $('#kt_modal_invite_friends').modal('hide'); // Fermer la modal
                        location.reload(); // Recharger la page pour afficher le nouvel incident
                    } else {
                        // Afficher les erreurs du formulaire
                        $('#kt_modal_invite_friends .modal-body').html(response.form);
                    }
                }
            });
        });

        // Réinitialiser le formulaire lorsque la modal est fermée
        $('#kt_modal_invite_friends').on('hidden.bs.modal', function () {
            $('#kt_contact_form')[0].reset(); // Réinitialiser le formulaire
        });
    });
</script>

<script>
    // Fonction utilitaire pour mettre à jour les paramètres GET
    function updateQueryStringParameter(uri, key, value) {
        const re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
        const separator = uri.indexOf('?') !== -1 ? "&" : "?";
        if (uri.match(re)) {
            return uri.replace(re, '$1' + key + "=" + value + '$2');
        }
        return uri + separator + key + "=" + value;
    }
    
    // Initialisation des selects
    $(document).ready(function() {
        $('[data-control="select2"]').select2({
            minimumResultsForSearch: Infinity
        });
        
        // Initialisation de DataTable (sans filtrage côté client)
        $('#kt_incidents_table').DataTable({
            "dom": '<"top"i>rt<"bottom"lp><"clear">',
            "searching": false,  // Désactive la recherche de DataTables
            "serverSide": false, // Utilise le filtrage côté serveur via django-filter
            "ordering": false,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
            }
        });
    });
    </script>

<script>
    document.getElementById('searchFieldSelector').addEventListener('change', function() {
        // Cache tous les champs
        document.querySelectorAll('.search-field').forEach(field => {
            field.style.display = 'none';
        });
        
        // Affiche le champ sélectionné
        if (this.value) {
            const field = document.querySelector(this.value);
            if (field) {
                field.style.display = 'block';
                
                // Initialise Select2 si nécessaire
                const select = field.querySelector('select');
                if (select) {
                    $(select).select2();
                }
            }
        }
    });
    </script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $("#id_site").change(function() {
            var siteId = $(this).val();
            if (siteId) {
                $.ajax({
                    url: "{% url 'get_emplacements' %}",  
                    data: { 'site_id': siteId },
                    dataType: 'json',
                    success: function(data) {
                        var $emplacement = $("#id_emplacement");
                        $emplacement.empty();
                        $.each(data, function(index, item) {
                            $emplacement.append(new Option(item.name, item.id));
                        });
                        $emplacement.closest('.fv-row').show();
                    }
                });
            } else {
                $("#id_emplacement").closest('.fv-row').hide();
            }
        }).trigger('change');
    });
</script>
    

{% endblock %}